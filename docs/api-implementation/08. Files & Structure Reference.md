# WhatsFlow API System - Files Reference

Complete reference of all files created for the Public API system.

## 📁 File Structure

```
whatsflow/
├── API_QUICKSTART.md                      # 5-minute quick start guide
├── API_SETUP_GUIDE.md                     # Detailed setup instructions
├── API_IMPLEMENTATION_SUMMARY.md          # Technical implementation details
│
├── whatsflow/backend/
│   ├── API_PUBLIC_REFERENCE.md            # Complete API reference
│   │
│   ├── migrations/
│   │   └── create_api_system.sql          # Database schema for API system
│   │
│   ├── src/
│   │   ├── services/
│   │   │   ├── api-key.service.ts         # API key management
│   │   │   └── webhook.service.ts         # Webhook delivery & management
│   │   │
│   │   ├── middleware/
│   │   │   ├── api-auth.middleware.ts     # API key authentication
│   │   │   └── api-rate-limit.middleware.ts # Rate limiting
│   │   │
│   │   ├── controllers/
│   │   │   └── public-api.controller.ts   # Public API endpoints
│   │   │
│   │   └── routes/
│   │       ├── public-api.routes.ts       # Public API routes (/api/public/v1)
│   │       └── api-keys.routes.ts         # API key management routes
│   │
│   └── examples/
│       ├── README.md                      # Examples documentation
│       ├── nodejs-sdk.js                  # Node.js SDK
│       ├── python-sdk.py                  # Python SDK
│       ├── webhook-server-express.js      # Express.js webhook server
│       ├── webhook-server-flask.py        # Flask webhook server
│       ├── test-api.sh                    # API testing script
│       └── whatsflow-api.postman_collection.json # Postman collection
│
└── frontend/
    ├── src/
    │   ├── lib/api/
    │   │   ├── api-keys.ts                # API key management client
    │   │   └── webhooks.ts                # Webhook management client
    │   │
    │   ├── components/docs/
    │   │   ├── CodeBlock.tsx              # Code syntax highlighting
    │   │   ├── ApiEndpoint.tsx            # API endpoint template
    │   │   └── DocsSidebar.tsx            # Documentation navigation
    │   │
    │   └── app/(dashboard)/
    │       ├── settings/
    │       │   ├── api-keys/page.tsx      # API key management UI
    │       │   └── webhooks/page.tsx      # Webhook management UI
    │       │
    │       └── docs/
    │           ├── page.tsx               # Introduction & quick start
    │           ├── authentication/page.tsx # Auth documentation
    │           ├── messaging/page.tsx     # Messaging API docs
    │           ├── devices/page.tsx       # Device management docs
    │           ├── contacts/page.tsx      # Contacts API docs
    │           ├── webhooks/page.tsx      # Webhook setup guide
    │           └── rate-limits/page.tsx   # Rate limit documentation
    │
    └── Updated: app/(dashboard)/layout.tsx # Added navigation links
```

---

## 🎯 File Purposes

### Documentation Files (Root Level)

| File | Purpose | Audience |
|------|---------|----------|
| `API_QUICKSTART.md` | 5-minute getting started guide | Developers (first time) |
| `API_SETUP_GUIDE.md` | Detailed setup & troubleshooting | Developers (reference) |
| `API_IMPLEMENTATION_SUMMARY.md` | Technical implementation details | Developers/DevOps |
| `API_FILES_REFERENCE.md` | This file - complete file listing | Developers/Maintainers |

### Backend Files

#### Database
- **`create_api_system.sql`** - Migration to create API tables
  - Run once: `mysql -u whatsapp_user -p whatsapp_db < create_api_system.sql`

#### Services
- **`api-key.service.ts`** - Core API key logic
  - Key generation with `wf_live_` / `wf_test_` prefixes
  - SHA256 hashing for security
  - Scope validation
  - Usage tracking

- **`webhook.service.ts`** - Webhook delivery system
  - Event queueing
  - HMAC-SHA256 signature generation
  - Retry logic (5 attempts, exponential backoff)
  - Delivery logging

#### Middleware
- **`api-auth.middleware.ts`** - Authentication
  - Validates API keys from Authorization header
  - Loads business profile and subscription
  - Enforces scopes

- **`api-rate-limit.middleware.ts`** - Rate limiting
  - Redis-backed counters
  - Plan-based limits (10-1000 req/min)
  - Rate limit headers

#### Routes & Controllers
- **`public-api.routes.ts`** - Route definitions for `/api/public/v1`
- **`api-keys.routes.ts`** - Management routes for `/api/v1/api-keys`
- **`public-api.controller.ts`** - Request handlers

#### Examples & SDKs
- **`nodejs-sdk.js`** - Production-ready Node.js SDK
- **`python-sdk.py`** - Production-ready Python SDK
- **`webhook-server-express.js`** - Express.js webhook server template
- **`webhook-server-flask.py`** - Flask webhook server template
- **`test-api.sh`** - Automated testing script
- **`whatsflow-api.postman_collection.json`** - Import into Postman/Insomnia

### Frontend Files

#### API Clients
- **`lib/api/api-keys.ts`** - API key management API calls
- **`lib/api/webhooks.ts`** - Webhook management API calls

#### Management Pages
- **`settings/api-keys/page.tsx`** - Create/manage API keys
  - Show key only once on creation
  - Copy-to-clipboard functionality
  - Scope selection
  - Usage statistics

- **`settings/webhooks/page.tsx`** - Configure webhooks
  - Register webhook URLs
  - Event subscription
  - Delivery logs
  - Test webhooks

#### Documentation Pages
All in `app/(dashboard)/docs/`:
- **`page.tsx`** - API introduction, features, quick start
- **`authentication/page.tsx`** - API key guide, best practices
- **`messaging/page.tsx`** - Send messages, message status
- **`devices/page.tsx`** - Device management endpoints
- **`contacts/page.tsx`** - Contact management endpoints
- **`webhooks/page.tsx`** - Webhook setup & verification
- **`rate-limits/page.tsx`** - Rate limit tiers & handling

#### Documentation Components
- **`CodeBlock.tsx`** - Syntax-highlighted code with copy button
- **`ApiEndpoint.tsx`** - Consistent endpoint documentation
- **`DocsSidebar.tsx`** - Navigation for documentation pages

---

## 🚀 Getting Started Checklist

### Initial Setup

- [ ] Run database migration: `create_api_system.sql`
- [ ] Restart backend server
- [ ] Login to WhatsFlow dashboard
- [ ] Connect at least one WhatsApp device
- [ ] Verify device status is "connected"

### API Testing

- [ ] Navigate to Settings → API Keys
- [ ] Create new API key with required scopes
- [ ] Copy and save API key securely
- [ ] Run test script: `./examples/test-api.sh`
- [ ] Verify all tests pass

### Webhook Setup (Optional)

- [ ] Create webhook endpoint (use example servers)
- [ ] Expose endpoint with ngrok (for local testing)
- [ ] Navigate to Settings → Webhooks
- [ ] Register webhook URL
- [ ] Save webhook secret
- [ ] Test webhook delivery
- [ ] Verify signature validation works

### Integration

- [ ] Copy SDK file to your project (`nodejs-sdk.js` or `python-sdk.py`)
- [ ] Set API key in environment variables
- [ ] Test sending messages
- [ ] Implement webhook handler
- [ ] Deploy to production

---

## 📊 API Endpoints Summary

### Public API (`/api/public/v1`)

**Messaging:**
- `POST /messages/send` - Send message
- `GET /messages/:id` - Get status
- `GET /messages` - List messages

**Devices:**
- `GET /devices` - List devices
- `GET /devices/:id/status` - Device status

**Contacts:**
- `GET /contacts` - List contacts
- `GET /contacts/:id` - Get contact
- `POST /contacts/verify` - Verify number

**Webhooks:**
- `GET /webhooks` - List webhooks
- `POST /webhooks` - Create webhook
- `PUT /webhooks/:id` - Update webhook
- `DELETE /webhooks/:id` - Delete webhook
- `POST /webhooks/:id/test` - Test webhook
- `GET /webhooks/:id/deliveries` - Delivery logs

### Management API (`/api/v1/api-keys`) - Uses JWT

- `GET /api-keys` - List API keys
- `POST /api-keys` - Create key
- `PUT /api-keys/:id` - Update key
- `DELETE /api-keys/:id` - Delete key
- `GET /api-keys/:id/usage` - Usage stats

---

## 🔐 Security Features

- ✅ API keys hashed with SHA256 (never stored in plain text)
- ✅ Scope-based permission system
- ✅ HMAC-SHA256 webhook signatures
- ✅ Timing-safe signature comparison
- ✅ Redis-backed rate limiting
- ✅ Plan-based usage quotas
- ✅ Request logging and audit trail
- ✅ Environment separation (live/test keys)

---

## 🎨 Customization Points

### Add Custom Scopes

Edit `api-key.service.ts`:
```typescript
static readonly AVAILABLE_SCOPES = [
  ...existing scopes...,
  'custom:scope', // Add your custom scope
];
```

### Add Custom Webhook Events

Edit `webhook.service.ts`:
```typescript
static readonly AVAILABLE_EVENTS = [
  ...existing events...,
  'custom.event', // Add your custom event
];
```

### Adjust Rate Limits

Edit `api-rate-limit.middleware.ts`:
```typescript
const RATE_LIMIT_TIERS = {
  custom_tier: {
    windowMs: 60 * 1000,
    maxRequests: 500,
  },
};
```

---

## 📈 Monitoring & Maintenance

### View API Usage

1. Dashboard → Settings → API Keys
2. Click on any key to see usage statistics
3. Review request counts and last used timestamps

### Monitor Webhook Deliveries

1. Dashboard → Settings → Webhooks
2. Click on any webhook
3. View "Recent Deliveries" section
4. Check success/failure rates

### Database Queries

```sql
-- API request statistics
SELECT 
  DATE(created_at) as date,
  COUNT(*) as requests,
  AVG(response_time_ms) as avg_time
FROM api_request_logs
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at);

-- Webhook delivery success rate
SELECT 
  webhook_id,
  COUNT(*) as total_deliveries,
  SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as successful,
  AVG(attempt_number) as avg_attempts
FROM webhook_deliveries
GROUP BY webhook_id;

-- Most active API keys
SELECT 
  ak.name,
  ak.requests_count,
  ak.last_used_at
FROM api_keys ak
WHERE ak.is_active = 1
ORDER BY ak.requests_count DESC
LIMIT 10;
```

---

## 🔄 Update Checklist

When updating the API system:

- [ ] Update migration file if schema changes
- [ ] Update service classes for new functionality
- [ ] Add/update routes and controllers
- [ ] Update frontend API clients
- [ ] Update documentation pages
- [ ] Add examples for new features
- [ ] Update Postman collection
- [ ] Test all endpoints
- [ ] Update this reference file

---

## 📞 Support

Questions about specific files? Check:

1. **Setup issues:** `API_SETUP_GUIDE.md`
2. **Usage questions:** Interactive docs at `/docs`
3. **Integration help:** `whatsflow/backend/examples/README.md`
4. **API reference:** `whatsflow/backend/API_PUBLIC_REFERENCE.md`

---

**Last Updated:** October 11, 2025

