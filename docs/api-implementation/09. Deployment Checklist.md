# WhatsFlow API - Deployment Checklist

Complete checklist for deploying the Public API system to production.

## ✅ Pre-Deployment Checklist

### Database
- [ ] Run migration: `create_api_system.sql`
- [ ] Verify tables created: `api_keys`, `webhooks`, `webhook_deliveries`, `api_request_logs`
- [ ] Check indexes are present
- [ ] Backup database before migration

### Backend Server
- [ ] Environment variables configured
- [ ] Redis running and accessible
- [ ] MySQL running and accessible
- [ ] Port 2152 available (or configured port)
- [ ] CORS origin set correctly
- [ ] Backend starts without errors: `npm run dev`
- [ ] Health check responds: `curl http://localhost:2152/health`

### Frontend Application
- [ ] Frontend starts without errors: `npm run dev`
- [ ] Can login to dashboard
- [ ] Settings → API Keys page loads
- [ ] Settings → Webhooks page loads
- [ ] API Docs page loads: `/docs`

### WhatsApp Integration
- [ ] At least one device connected
- [ ] Device status shows "connected"
- [ ] Can send messages through dashboard
- [ ] Messages appear in Messages page

---

## 🧪 Testing Checklist

### API Key Management
- [ ] Can create API key from dashboard
- [ ] Key is shown only once on creation
- [ ] Can copy key to clipboard
- [ ] Can select multiple scopes
- [ ] Can choose live vs test environment
- [ ] Created key appears in list
- [ ] Can view key usage statistics
- [ ] Can deactivate key
- [ ] Can delete key

### Public API Endpoints

#### Messaging
- [ ] `POST /messages/send` works with valid key
- [ ] Returns message_id in response
- [ ] Message appears in WhatsApp
- [ ] `GET /messages/:id` returns message status
- [ ] `GET /messages` returns paginated list
- [ ] Returns 401 with invalid key
- [ ] Returns 403 without `messages:send` scope

#### Devices
- [ ] `GET /devices` returns device list
- [ ] `GET /devices/:id/status` returns status
- [ ] Connected devices show "connected" status
- [ ] Returns 403 without `devices:read` scope

#### Contacts
- [ ] `GET /contacts` returns contact list
- [ ] Pagination works correctly
- [ ] `GET /contacts/:id` returns contact details
- [ ] Returns 404 for non-existent contact

### Rate Limiting
- [ ] Response includes `X-RateLimit-Limit` header
- [ ] Response includes `X-RateLimit-Remaining` header
- [ ] Response includes `X-RateLimit-Reset` header
- [ ] Returns 429 when limit exceeded
- [ ] Counter resets after window
- [ ] Different plans have different limits

### Webhooks

#### Creation & Management
- [ ] Can create webhook from dashboard
- [ ] Secret shown only once on creation
- [ ] Can select multiple events
- [ ] Created webhook appears in list
- [ ] Can update webhook URL
- [ ] Can update subscribed events
- [ ] Can deactivate webhook
- [ ] Can delete webhook

#### Delivery
- [ ] Test webhook sends event
- [ ] Webhook endpoint receives POST request
- [ ] Payload format is correct
- [ ] Headers include `X-Webhook-Event`
- [ ] Headers include `X-Webhook-Signature`
- [ ] Headers include `X-Webhook-Delivery-Id`
- [ ] Signature verification works
- [ ] Failed deliveries retry automatically
- [ ] Delivery logs appear in dashboard

#### Events
- [ ] `message.received` triggers on inbound message
- [ ] `message.sent` triggers when API sends message
- [ ] `device.connected` triggers on device connection
- [ ] `device.disconnected` triggers on disconnection

---

## 🔒 Security Checklist

### API Keys
- [ ] Keys hashed with SHA256 (never plain text in DB)
- [ ] Keys shown only once on creation
- [ ] Can revoke keys instantly
- [ ] Inactive keys rejected by API
- [ ] Different scopes enforced correctly

### Webhooks
- [ ] Signatures use HMAC-SHA256
- [ ] Secrets are cryptographically random (64 hex chars)
- [ ] Signature verification works correctly
- [ ] Webhook URLs validated (proper URL format)
- [ ] HTTPS recommended for production

### Rate Limiting
- [ ] Limits enforced per API key
- [ ] Limits based on subscription plan
- [ ] Redis stores rate limit state
- [ ] Headers inform about remaining quota
- [ ] 429 response includes retry-after

---

## 📊 Monitoring Checklist

### API Usage
- [ ] Can view request count per key
- [ ] Last used timestamp updates
- [ ] Usage statistics show request history
- [ ] Request logs stored in database

### Webhook Deliveries
- [ ] Delivery logs visible in dashboard
- [ ] Success/failure counts accurate
- [ ] Can view individual delivery attempts
- [ ] Failed deliveries show error messages
- [ ] Retry attempts tracked correctly

### System Health
- [ ] Backend health endpoint responding
- [ ] Redis connection stable
- [ ] MySQL connection stable
- [ ] WhatsApp connections active
- [ ] No errors in backend logs

---

## 🚀 Production Deployment

### Pre-Production
1. **Test Everything**
   - [ ] Run `test-api.sh` successfully
   - [ ] Test all webhook events
   - [ ] Verify signature validation
   - [ ] Load test rate limiting

2. **Security Review**
   - [ ] No API keys in code/configs
   - [ ] Environment variables configured
   - [ ] HTTPS for webhook endpoints
   - [ ] Firewall rules configured

3. **Documentation**
   - [ ] Team trained on API usage
   - [ ] Integration guides created
   - [ ] Support docs updated

### Production
4. **Database**
   - [ ] Backup before migration
   - [ ] Run migration on production DB
   - [ ] Verify tables created
   - [ ] Set up automated backups

5. **Backend**
   - [ ] Set production environment variables
   - [ ] Configure production Redis
   - [ ] Set CORS_ORIGIN to production frontend URL
   - [ ] Enable production logging
   - [ ] Configure SSL/TLS
   - [ ] Deploy to production server

6. **Frontend**
   - [ ] Set NEXT_PUBLIC_API_URL to production backend
   - [ ] Build for production: `npm run build`
   - [ ] Deploy to hosting (Vercel, etc.)
   - [ ] Verify docs pages load

7. **Monitoring**
   - [ ] Set up error alerts
   - [ ] Monitor API usage
   - [ ] Track webhook delivery rates
   - [ ] Set up uptime monitoring
   - [ ] Configure log aggregation

### Post-Deployment
8. **Verification**
   - [ ] Create production API key
   - [ ] Test all endpoints in production
   - [ ] Verify webhooks deliver
   - [ ] Check rate limits work
   - [ ] Monitor for 24 hours

9. **Documentation**
   - [ ] Update base URLs in docs
   - [ ] Share API docs with users
   - [ ] Create support materials
   - [ ] Update Postman collection

---

## 🔍 Troubleshooting Production Issues

### API Key Not Working
```bash
# Check key in database
mysql> SELECT id, name, environment, is_active, scopes 
       FROM api_keys 
       WHERE key_hash = SHA2('wf_live_xxx', 256);

# Verify key not revoked
# Check is_active = 1
# Verify scopes include required permission
```

### Webhooks Not Delivering
```bash
# Check webhook configuration
mysql> SELECT id, url, is_active, events, success_count, failure_count 
       FROM webhooks 
       WHERE business_profile_id = 'xxx';

# Check recent deliveries
mysql> SELECT * FROM webhook_deliveries 
       WHERE webhook_id = 'xxx' 
       ORDER BY delivered_at DESC 
       LIMIT 10;

# Verify webhook URL is accessible
curl -X POST https://your-webhook-url \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

### Rate Limit Issues
```bash
# Check Redis
redis-cli

# View rate limit keys
KEYS ratelimit:api:*

# Check specific key
GET ratelimit:api:key_id_here
TTL ratelimit:api:key_id_here
```

---

## 📈 Performance Benchmarks

### Expected Performance
- **API Response Time:** < 100ms (non-message endpoints)
- **Message Sending:** < 2s (depends on WhatsApp)
- **Webhook Delivery:** < 5s (depends on endpoint)
- **Rate Limit Check:** < 5ms (Redis)

### Optimization Tips
- Use Redis for caching
- Index database columns properly
- Implement connection pooling
- Use async webhook delivery
- Monitor slow queries

---

## 🎯 Success Metrics

### Technical
- ✅ 99.9% API uptime
- ✅ < 100ms average response time
- ✅ > 95% webhook delivery success rate
- ✅ Zero security incidents

### Business
- ✅ Users can create API keys
- ✅ External integrations work
- ✅ Documentation is clear
- ✅ Support tickets are minimal

---

## 🆘 Rollback Plan

If issues occur in production:

1. **Disable Public API** (Emergency)
   ```javascript
   // In app.ts, comment out:
   // app.use('/api/public/v1', publicAPIRoutes);
   ```

2. **Disable Webhooks** (Less Severe)
   ```sql
   UPDATE webhooks SET is_active = 0;
   ```

3. **Full Rollback** (Database)
   ```sql
   -- Backup first!
   DROP TABLE api_request_logs;
   DROP TABLE webhook_deliveries;
   DROP TABLE webhooks;
   -- Restore api_keys to original state
   ```

---

## ✅ Final Verification

Before considering deployment complete:

- [ ] All checklist items above completed
- [ ] Test script passes: `./test-api.sh`
- [ ] Webhooks tested and working
- [ ] Documentation accessible
- [ ] No linter errors
- [ ] No console errors in frontend
- [ ] No errors in backend logs
- [ ] Rate limiting tested
- [ ] Signature verification tested
- [ ] Team trained on API usage
- [ ] Support docs created
- [ ] Monitoring configured

---

## 🎓 Training Materials

### For End Users
1. Show them: Settings → API Keys
2. Walk through: Creating first API key
3. Demo: Sending message via API
4. Show: Interactive documentation

### For Developers
1. Share: `API_QUICKSTART.md`
2. Provide: SDK files
3. Review: Integration examples
4. Explain: Webhook setup

### For Support Team
1. Train on: API key management
2. Explain: Common error messages
3. Show: How to check delivery logs
4. Document: Escalation procedures

---

## 📞 Support Resources

- **Documentation:** http://localhost:2153/docs (or production URL)
- **API Reference:** `whatsflow/backend/API_PUBLIC_REFERENCE.md`
- **Examples:** `whatsflow/backend/examples/`
- **This Checklist:** Review before each deployment

---

**Status:** Ready for Deployment ✅

**Last Updated:** October 11, 2025

