# WhatsFlow Public API Setup Guide

Complete guide for setting up and using the WhatsFlow Public API for external integrations.

## üìã Table of Contents

1. [Database Setup](#database-setup)
2. [Creating API Keys](#creating-api-keys)
3. [Testing the API](#testing-the-api)
4. [Setting Up Webhooks](#setting-up-webhooks)
5. [Integration Examples](#integration-examples)
6. [Troubleshooting](#troubleshooting)

---

## üóÑÔ∏è Database Setup

### 1. Run the API System Migration

```bash
cd /Users/digitalarc/Development/Webroot/whatsflow/whatsflow/backend

# Run the migration
mysql -u whatsapp_user -p whatsapp_db < migrations/create_api_system.sql
```

This creates the following tables:
- Updates `api_keys` table with scopes and rate limiting fields
- Creates `webhooks` table for webhook configurations
- Creates `webhook_deliveries` table for delivery logs
- Creates `api_request_logs` table for analytics

### 2. Verify Migration

```bash
mysql -u whatsapp_user -p whatsapp_db

# In MySQL:
SHOW TABLES;
DESCRIBE api_keys;
DESCRIBE webhooks;
```

---

## üîë Creating API Keys

### Via Web Interface (Recommended)

1. **Navigate to API Keys:**
   - Login to WhatsFlow: `http://localhost:2153`
   - Go to **Settings ‚Üí API Keys**

2. **Create New Key:**
   - Click "Create API Key"
   - Enter a descriptive name (e.g., "Production CRM Integration")
   - Select environment: Live or Test
   - Choose required scopes:
     - `messages:send` - Send WhatsApp messages
     - `messages:read` - Read message history
     - `devices:read` - View device information
     - `contacts:read` - View contacts
     - `webhooks:manage` - Manage webhooks
   - Click "Create API Key"

3. **Save Your Key:**
   - **IMPORTANT:** The API key is shown only once!
   - Copy it immediately: `wf_live_abc123xyz789...`
   - Store it securely (environment variables, secrets manager)

### Available Scopes

| Scope | Description | Required For |
|-------|-------------|--------------|
| `messages:send` | Send messages | Sending WhatsApp messages via API |
| `messages:read` | Read messages | Viewing message history and status |
| `devices:read` | View devices | Checking device connection status |
| `devices:manage` | Manage devices | Reconnecting devices (future) |
| `contacts:read` | View contacts | Listing and searching contacts |
| `contacts:write` | Modify contacts | Creating/updating contacts (future) |
| `webhooks:manage` | Manage webhooks | Configuring webhook endpoints |

---

## üß™ Testing the API

### 1. Test Authentication

```bash
# Replace YOUR_API_KEY with your actual key
export API_KEY="wf_live_your_key_here"
export BASE_URL="http://localhost:2152/api/public/v1"

# Test: List devices
curl -H "Authorization: Bearer $API_KEY" \
     -H "Content-Type: application/json" \
     $BASE_URL/devices
```

**Expected Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "device_abc123",
      "device_name": "Main Line",
      "status": "connected",
      ...
    }
  ]
}
```

### 2. Send a Test Message

```bash
# Make sure you have at least one connected device first!

curl -X POST "$BASE_URL/messages/send" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "phone_number": "+94771234567",
    "message": "Test message from WhatsFlow API!"
  }'
```

**Expected Response:**
```json
{
  "success": true,
  "data": {
    "message_id": "msg_xyz789",
    "phone_number": "+94771234567",
    "message": "Test message from WhatsFlow API!",
    "status": "sent",
    "timestamp": "2025-10-11T10:30:00.000Z"
  }
}
```

### 3. Check Rate Limits

```bash
# Make a request and inspect headers
curl -v -H "Authorization: Bearer $API_KEY" $BASE_URL/devices

# Look for these headers in the response:
# X-RateLimit-Limit: 100
# X-RateLimit-Remaining: 99
# X-RateLimit-Reset: 1696852860
```

---

## üîî Setting Up Webhooks

### 1. Create a Webhook Endpoint

First, set up a public endpoint to receive webhooks. Here's a simple Express.js example:

```javascript
// webhook-server.js
const express = require('express');
const crypto = require('crypto');

const app = express();
app.use(express.json());

const WEBHOOK_SECRET = 'whsec_your_secret_here'; // Get from WhatsFlow

function verifySignature(payload, signature) {
  const expected = crypto
    .createHmac('sha256', WEBHOOK_SECRET)
    .update(JSON.stringify(payload))
    .digest('hex');
  return signature === `sha256=${expected}`;
}

app.post('/webhooks/whatsflow', (req, res) => {
  const signature = req.headers['x-webhook-signature'];
  
  // Verify signature
  if (!verifySignature(req.body, signature)) {
    console.log('‚ùå Invalid webhook signature');
    return res.status(401).send('Invalid signature');
  }
  
  console.log('‚úÖ Webhook received:', req.body.event);
  console.log('Data:', req.body.data);
  
  // Process the event...
  
  res.status(200).send('OK');
});

app.listen(3000, () => {
  console.log('Webhook server running on port 3000');
});
```

### 2. Expose Your Endpoint (Development)

For local development, use ngrok to expose your endpoint:

```bash
# Install ngrok
brew install ngrok

# Expose your local server
ngrok http 3000

# Copy the HTTPS URL: https://abc123.ngrok.io
```

### 3. Register Webhook in WhatsFlow

**Via Web Interface:**
1. Go to **Settings ‚Üí Webhooks**
2. Enter your API key (needs `webhooks:manage` scope)
3. Click "Create Webhook"
4. Enter webhook URL: `https://abc123.ngrok.io/webhooks/whatsflow`
5. Select events to subscribe to
6. Click "Create Webhook"
7. **SAVE THE SECRET** (shown only once!)

**Via API:**
```bash
curl -X POST "$BASE_URL/webhooks" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://abc123.ngrok.io/webhooks/whatsflow",
    "events": ["message.received", "device.disconnected"],
    "description": "Development webhook"
  }'
```

### 4. Test Your Webhook

```bash
# Via API
curl -X POST "$BASE_URL/webhooks/webhook_id_here/test" \
  -H "Authorization: Bearer $API_KEY"

# Or click "Test" button in the webhooks management interface
```

---

## üíº Integration Examples

### Accounting Software Integration

```javascript
// Send invoice reminders via WhatsApp
const WhatsFlowAPI = require('./whatsflow-api');

const api = new WhatsFlowAPI('wf_live_your_key');

async function sendInvoiceReminder(customer) {
  const message = `Hi ${customer.name}, your invoice #${customer.invoice_id} is due on ${customer.due_date}. Please make payment to avoid late fees.`;
  
  try {
    const result = await api.sendMessage(customer.phone, message);
    console.log(`Invoice reminder sent to ${customer.name}`);
    
    // Log in accounting system
    await logCommunication(customer.id, result.message_id);
  } catch (error) {
    console.error('Failed to send reminder:', error);
  }
}
```

### CRM Integration with Webhooks

```javascript
// Sync incoming WhatsApp messages to CRM
app.post('/webhooks/whatsflow', async (req, res) => {
  const event = req.body;
  
  if (event.event === 'message.received') {
    const { phone_number, contact_name, message } = event.data;
    
    // Create or update contact in CRM
    await CRM.updateContact({
      phone: phone_number,
      name: contact_name,
      lastContact: new Date(),
    });
    
    // Log interaction
    await CRM.logInteraction({
      phone: phone_number,
      type: 'whatsapp_inbound',
      message: message,
      timestamp: event.timestamp,
    });
  }
  
  res.status(200).send('OK');
});
```

### Automated Customer Support

```javascript
// Auto-respond to keywords
const api = new WhatsFlowAPI('wf_live_your_key');

app.post('/webhooks/whatsflow', async (req, res) => {
  const event = req.body;
  
  if (event.event === 'message.received') {
    const { phone_number, message } = event.data;
    const lowerMessage = message.toLowerCase();
    
    // Auto-respond to common queries
    if (lowerMessage.includes('hours')) {
      await api.sendMessage(phone_number, 
        'Our business hours are Monday-Friday 9am-5pm. How can we help?'
      );
    } else if (lowerMessage.includes('price') || lowerMessage.includes('cost')) {
      await api.sendMessage(phone_number,
        'Please visit https://example.com/pricing for our latest prices.'
      );
    }
  }
  
  res.status(200).send('OK');
});
```

---

## üîç Troubleshooting

### API Key Not Working

**Problem:** Getting 401 Unauthorized errors

**Solutions:**
1. Check API key format: Should start with `wf_live_` or `wf_test_`
2. Verify key is active (not revoked) in Settings ‚Üí API Keys
3. Ensure key has required scopes for the endpoint
4. Check Authorization header format: `Bearer wf_live_xxx` (note the space)

### Rate Limit Errors

**Problem:** Getting 429 Too Many Requests

**Solutions:**
1. Check your subscription plan limits
2. Implement exponential backoff in your code
3. Monitor `X-RateLimit-Remaining` header
4. Consider upgrading your plan for higher limits
5. Use webhooks instead of polling for real-time updates

### Webhook Not Receiving Events

**Problem:** Webhook endpoint not being called

**Solutions:**
1. Verify webhook URL is publicly accessible (use ngrok for local testing)
2. Check webhook is active in Settings ‚Üí Webhooks
3. Ensure you're subscribed to the correct events
4. Check delivery logs in webhook management interface
5. Verify your endpoint returns 200 OK within 30 seconds
6. Check firewall/network settings

### Webhook Signature Verification Failing

**Problem:** Signature validation fails

**Solutions:**
1. Use the exact secret shown when webhook was created
2. Verify you're hashing the raw JSON payload (not parsed object)
3. Check HMAC algorithm is SHA256
4. Ensure signature format is: `sha256=hash_value`
5. Use timing-safe comparison for validation

### Message Not Sending

**Problem:** API call succeeds but message doesn't send

**Solutions:**
1. Verify you have at least one connected device
2. Check device status: GET /devices
3. Ensure phone number includes country code
4. Check subscription message limits not exceeded
5. Review device connection in WhatsApp settings

---

## üìä Monitoring & Analytics

### Track API Usage

View API usage statistics for each key:

```bash
curl -H "Authorization: Bearer $API_KEY" \
     "$BASE_URL/../api-keys/key_id_here/usage?days=7"
```

### Webhook Delivery Success Rate

Monitor webhook deliveries in the dashboard:
- **Settings ‚Üí Webhooks**
- Click on a webhook
- View "Recent Deliveries" tab
- Check success/failure counts

### Rate Limit Monitoring

Always check rate limit headers:
```javascript
const response = await fetch(url, options);

const limit = response.headers.get('X-RateLimit-Limit');
const remaining = response.headers.get('X-RateLimit-Remaining');
const reset = response.headers.get('X-RateLimit-Reset');

console.log(`Rate limit: ${remaining}/${limit} (resets at ${new Date(reset * 1000)})`);
```

---

## üîí Security Best Practices

1. **Never commit API keys to version control**
   ```bash
   # Add to .gitignore
   .env
   .env.local
   ```

2. **Use environment variables**
   ```javascript
   const API_KEY = process.env.WHATSFLOW_API_KEY;
   ```

3. **Rotate keys regularly**
   - Create new key
   - Update integrations
   - Delete old key

4. **Use minimal scopes**
   - Only grant permissions needed
   - Create separate keys for different integrations

5. **Monitor API key usage**
   - Check last_used_at timestamps
   - Revoke unused keys
   - Review request logs

6. **Secure webhook endpoints**
   - Always verify signatures
   - Use HTTPS in production
   - Implement rate limiting on your endpoint
   - Log all webhook attempts

---

## üìö Additional Resources

- **Interactive Documentation:** Dashboard ‚Üí API Docs
- **Manage API Keys:** Dashboard ‚Üí Settings ‚Üí API Keys
- **Manage Webhooks:** Dashboard ‚Üí Settings ‚Üí Webhooks
- **API Reference:** `/whatsflow/backend/API_PUBLIC_REFERENCE.md`
- **Support:** support@whatsflow.ai

---

## üöÄ Production Checklist

Before going live:

- [ ] API keys created with appropriate scopes
- [ ] Test environment thoroughly tested
- [ ] Webhook signatures verified correctly
- [ ] Error handling implemented
- [ ] Rate limit monitoring in place
- [ ] API keys stored securely (environment variables)
- [ ] Webhook endpoint uses HTTPS
- [ ] Logging and monitoring configured
- [ ] Subscription plan supports required usage
- [ ] Backup API key created and stored securely

---

## Example: Complete Integration Flow

```javascript
// 1. Initialize API client
const WhatsFlowAPI = require('./whatsflow-api');
const api = new WhatsFlowAPI(process.env.WHATSFLOW_API_KEY);

// 2. Check devices are connected
const devices = await api.listDevices();
if (devices.filter(d => d.status === 'connected').length === 0) {
  throw new Error('No connected devices. Please connect a device first.');
}

// 3. Send message
const result = await api.sendMessage('+94771234567', 'Hello!');
console.log('Message sent:', result.message_id);

// 4. Set up webhook handler
app.post('/webhooks/whatsflow', verifySignature, async (req, res) => {
  const event = req.body;
  
  switch (event.event) {
    case 'message.received':
      await handleIncomingMessage(event.data);
      break;
    case 'message.delivered':
      await updateMessageStatus(event.data.message_id, 'delivered');
      break;
    case 'device.disconnected':
      await sendAdminAlert(event.data);
      break;
  }
  
  res.status(200).send('OK');
});

// 5. Monitor rate limits
setInterval(async () => {
  const stats = await api.getKeyUsage(7);
  console.log('API usage last 7 days:', stats);
}, 3600000); // Every hour
```

---

## Need Help?

- üìß Email: support@whatsflow.ai
- üìö Docs: http://localhost:2153/docs
- üí¨ Support: Available in your dashboard

---

**Ready to integrate? Start by creating your first API key!**

Dashboard ‚Üí Settings ‚Üí API Keys ‚Üí Create API Key

